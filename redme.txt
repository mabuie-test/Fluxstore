Guia de deploy no Render (Fluxstore Backend + Frontend)
======================================================

Este documento descreve como publicar **backend** e **frontend** da Fluxstore no Render com MongoDB, Mpesa e SMTP. Use como checklist
para não esquecer variáveis, build do SPA e paths corretos.

1) Preparação do repositório
----------------------------
- Garanta que o repositório está no GitHub/GitLab. O Render irá puxar o código a partir do branch principal.
- Mantenha o backend em `backend/` com o script `start` configurado (`NODE_ENV=production node src/app.js`).
- O frontend Vite fica em `frontend/` e o build estático é gerado em `frontend/dist`.
- Nunca commite `.env`; use apenas `.env.example` como referência.

2) Variáveis de ambiente necessárias (backend)
----------------------------------------------
Crie um Environment Group com os valores reais:
- `PORT` – porta exposta (Render define automaticamente; pode deixar em branco ou repetir o valor padrão).
- `MONGO_URI` – string de conexão do MongoDB (ex.: `mongodb+srv://user:pass@cluster.mongodb.net/fluxstore`).
- `JWT_SECRET` – segredo forte para tokens JWT.
- `MPESA_CONSUMER_KEY` – chave pública da app Daraja.
- `MPESA_CONSUMER_SECRET` – segredo da app Daraja.
- `MPESA_SHORTCODE` – shortcode/código da organização.
- `MPESA_INITIATOR` – nome do initiator (B2C).
- `MPESA_INITIATOR_PASSWORD` – senha/credential para o initiator.
- `MPESA_BASE_URL` – URL base da API (sandbox ou produção, por exemplo `https://sandbox.safaricom.co.ke`).
- `SMTP_HOST` – host SMTP do provedor de email.
- `SMTP_PORT` – porta SMTP (587 ou 465).
- `SMTP_USER` – utilizador/conta SMTP (remetente).
- `SMTP_PASSWORD` – senha ou token da conta SMTP.
- `ALLOW_ADMIN_SELF_SIGNUP` – deixe `true` apenas em ambientes de teste para permitir o registo temporário de administradores direto no formulário.

Dicas:
- Separe credenciais de sandbox e produção em grupos diferentes (ex.: `fluxstore-sandbox` e `fluxstore-prod`).
- Webhooks da Mpesa podem ser parametrizados via variável dedicada (ex.: `MPESA_CALLBACK_URL`) se você expuser callbacks.

3) Variáveis de ambiente necessárias (frontend)
-----------------------------------------------
- `VITE_API_URL` – URL pública do backend (ex.: `https://<backend>.onrender.com/api`).
- `VITE_APP_NAME` (opcional) – nome a ser exibido nos títulos/hero.
- `VITE_BRAND_ACCENT` (opcional) – cor primária (hex ou rgb) para harmonizar o tema.

4) Provisionar o banco de dados
-------------------------------
- Use Render Managed Mongo ou MongoDB Atlas.
- Crie a database `fluxstore` e um utilizador com permissões de leitura/escrita.
- Copie a connection string completa para `MONGO_URI`.

5) Deploy do backend como Web Service
-------------------------------------
- Em "New" → "Web Service" → conecte o repositório.
- Root Directory: `backend`.
- Runtime: Node.
- Build Command (monorepo servindo SPA pelo Express):
  ```bash
  npm install \
    && npm --prefix ../frontend install \
    && npm --prefix ../frontend run build
  ```
- Start Command: `npm start`.
- Health Check Path: `/health` (já exposto em `src/app.js`).
- Associe o Environment Group do backend.

6) Deploy do frontend como Static Site (alternativa)
----------------------------------------------------
Se preferir separar frontend e backend:
- Em "New" → "Static Site".
- Root Directory: `frontend`.
- Build Command: `npm install && npm run build`.
- Publish Directory: `dist`.
- Defina `VITE_API_URL` nas "Environment Variables" apontando para o backend público.
- Habilite a opção "Pull Request Preview" apenas se precisar de ambientes de homologação.

7) Pipelining e domínios
------------------------
- Ative "Auto-Deploy" para o branch principal em ambos os serviços.
- Configure domínios personalizados: ex. `app.sualoja.com` para o Static Site e `api.sualoja.com` para o backend.
- Se usar o backend para servir o SPA, basta mapear o domínio no serviço Web e habilitar HTTPS.

8) Tarefas recorrentes
----------------------
- Use Render Cron Jobs para newsletters, limpeza de carrinhos abandonados e reconciliação de pagamentos Mpesa.
- Scripts sugeridos: `node src/services/marketingService.js --broadcast`, `node src/services/paymentService.js --reconcile` (ajuste handlers internos conforme sua automação).

9) Teste pós-deploy
-------------------
- `GET https://<backend>.onrender.com/health` para validar o container.
- Fluxo completo: registro → login → checkout Mpesa (sandbox) → confirmação de entrega → saque B2C.
- Valide emails de reset de senha, notificações e o centro de alertas/admin.
- Se usar Static Site, verifique se o `VITE_API_URL` está correto e se as rotas client-side funcionam (fallback SPA habilitado por padrão no Render).

10) Segurança e observabilidade
-------------------------------
- Nunca exponha secrets no repositório; rotacione `JWT_SECRET` e credenciais Mpesa periodicamente.
- Crie regras de CORS no backend se for servir o frontend em domínio separado.
- Ative alertas de logs/erros no Render para pagamentos, disputas e denúncias.
- Utilize audit logging embutido (`/api/audit`) para monitorar ações críticas.

Seguindo estes passos, backend e frontend da Fluxstore ficam prontos para produção no Render com build automatizado do SPA e variáveis separadas por ambiente.
